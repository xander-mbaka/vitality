define(["app_admin"],function(e){e.module("Entities",function(e,n,o,r,t){o.emulateJSON=!0,e.Journal=o.Model.extend({urlRoot:"presentation/journal"}),e.JournalCollection=o.Collection.extend({url:"/presentation/journals",model:e.Journal}),e.Issue=o.Model.extend({urlRoot:"presentation/journal"}),e.IssueCollection=o.Collection.extend({url:"/presentation/journals",model:e.Issue}),e.Article=o.Model.extend({urlRoot:"presentation/journal"}),e.ArticleCollection=o.Collection.extend({url:"/presentation/journals",model:e.Article}),e.Indicator=o.Model.extend({urlRoot:"presentation/trend"}),e.IndicatorCollection=o.Collection.extend({url:"/presentation/trends",model:e.Indicator}),e.Blog=o.Model.extend({urlRoot:"presentation/blog"}),e.BlogCollection=o.Collection.extend({url:"/presentation/blogs",model:e.Blog}),e.BlogComment=o.Model.extend({urlRoot:"presentation/blog"}),e.BlogCommentCollection=o.Collection.extend({url:"/presentation/blogs",model:e.BlogComment}),e.Model=o.Model.extend({urlRoot:"presentation/blog"}),e.Collection=o.Collection.extend({url:"/presentation/blogs",model:e.Model});var l,s=function(n){var o=new e.Collection(n);return o.models},i=function(){var n=new e.JournalCollection([{name:"American Economic Review",cover_img_url:"./assets/journalcovers/american econ review.jpg"},{name:"American Journal of Agricultural Economics",cover_img_url:"./assets/journalcovers/American Journal of Agricultural Econ.jpg"},{name:"Applied Economics",cover_img_url:"./assets/journalcovers/applied economics.jpg"},{name:"Ecological Economics",cover_img_url:"./assets/journalcovers/ecological econo.jpg"},{name:"Economic Journal",cover_img_url:"./assets/journalcovers/econ journal.jpg"},{name:"Economic Letters",cover_img_url:"./assets/journalcovers/econ letters.jpg"},{name:"Energy Economics",cover_img_url:"./assets/journalcovers/energy econ.jpg"},{name:"European Economic Review",cover_img_url:"./assets/journalcovers/european econ review.jpg"},{name:"Games & Economic Behavior",cover_img_url:"./assets/journalcovers/games and econ behaviour.jpg"},{name:"Health Economics",cover_img_url:"./assets/journalcovers/health econ.jpg"},{name:"Journal of Accounting & Economics",cover_img_url:"./assets/journalcovers/acc and econ.jpg"}]);return n.forEach(function(e){e.save()}),n.models},a=function(n,o,r){var t=new e.IssueCollection(n);return t.forEach(function(e){e.set("journal_id",o),e.set("journal_name",r)}),t.models},c=function(n){var o=new e.IssueCollection(n);return o.models},u=function(n){var o=new e.JournalCollection(n);return o.models},g=function(n){var o=new e.IndicatorCollection(n);return o.models},d=function(n){var o=new e.BlogCollection(n);return o.models},m=function(n){var o=new e.BlogCommentCollection(n);return o.models},f={getJournalEntities:function(){var n=new e.JournalCollection,o=t.Deferred();n.fetch({success:function(e){o.resolve(e)}});var r=o.promise();return t.when(r).done(function(e){0===e.length&&t.get("/presentation/journals/?journals",function(n){if(0===n.length){var o=i();e.reset(o)}else{var o=u(JSON.parse(n));e.reset(o)}})}),n},getJournalIssues:function(n){var o=n.get("journal_id"),r=n.get("name"),l=new e.IssueCollection,s=t.Deferred();return t.when(t.get("/presentation/journals/?issues&journalId="+o,function(e){var n=JSON.parse(e);if(0===n.length){var t=a(n,o,r);l.reset(t)}else{var t=a(n,o,r);l.reset(t)}})).done(function(){n.set("issues",l),s.resolve(n)}),s.promise()},getIssueArticles:function(n){var o=n.get("journal_id"),r=n.get("issue"),l=new e.ArticleCollection,s=t.Deferred();return t.when(t.get("/presentation/journals/?issue="+r+"&journalId="+o,function(e){var n=JSON.parse(e);if(0===n.length){var r=c(n,o);l.reset(r)}else{var r=c(n,o);l.reset(r)}})).done(function(){n.set("articles",l),s.resolve(n)}),s.promise()},getIndicatorEntities:function(){var n=new e.IndicatorCollection,o=t.Deferred();n.fetch({success:function(e){o.resolve(e)}});var r=o.promise();return t.when(r).done(function(e){0===e.length&&t.get("/presentation/trends",function(n){if(0===n.length){var o=initializeIndicator();e.reset(o)}else{alert(n);var o=g(JSON.parse(n));e.reset(o)}})}),n},getBlogEntities:function(){l=new e.BlogCollection;var n=t.Deferred();return t.when(t.get("/presentation/blogs",function(e){var n=d(JSON.parse(e));l.reset(n)})).done(function(){n.resolve(l)}),n.promise()},getCategoryEntities:function(){categories=new e.Collection;var n=t.Deferred();return t.when(t.get("/presentation/journals/?categories",function(e){var n=s(JSON.parse(e));categories.reset(n)})).done(function(){n.resolve(categories)}),n.promise()},getBlog:function(n){var o,r=new e.BlogCommentCollection,l=n.get("blog_id"),s=t.Deferred();return t.when(t.get("/presentation/blogs/?blogId="+l,function(e){o=e}),t.get("/presentation/blogs/?comments="+l,function(e){var n=m(JSON.parse(e));r.reset(n)})).done(function(){n.set("full",o),n.set("comments",r),s.resolve(n)}),s.promise()},getJournalEntity:function(n){var o=new e.journal({id:n}),r=t.Deferred();return setTimeout(function(){o.fetch({success:function(e){r.resolve(e)},error:function(){r.resolve(void 0)}})},2e3),r.promise()}};n.reqres.setHandler("load:entities",function(){f.loadEntities()}),n.reqres.setHandler("journal:entities",function(){return f.getJournalEntities()}),n.reqres.setHandler("category:entities",function(){return f.getCategoryEntities()}),n.reqres.setHandler("journal:issues",function(e){return f.getJournalIssues(e)}),n.reqres.setHandler("issue:articles",function(e){return f.getIssueArticles(e)}),n.reqres.setHandler("indicator:entities",function(){return f.getIndicatorEntities()}),n.reqres.setHandler("blog:entities",function(){return f.getBlogEntities()}),n.reqres.setHandler("blog:entity",function(e){return f.getBlog(e)}),n.reqres.setHandler("journal:entity",function(e){return f.getJournalEntity(e)}),n.reqres.setHandler("journal:entity:new",function(){return new e.Journal})})});